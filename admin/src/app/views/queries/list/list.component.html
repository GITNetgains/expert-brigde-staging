<c-row>
  <c-col md="12">
    <c-card>
      <c-card-header>
        <h4>AI Queries</h4>
        <p class="text-muted mb-0 small">All Clients AI queries with name and email</p>
      </c-card-header>
      <c-card-body>
        <div *ngIf="loading" class="d-flex justify-content-center p-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <ng-container *ngIf="!loading">
          <div *ngIf="aiQueries.length === 0" class="p-4 text-center text-muted">
            No AI queries found.
          </div>

          <div *ngIf="aiQueries.length > 0" class="table-responsive">
            <table class="table table-bordered align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Student Name</th>
                  <th>Email</th>
                  <th>Time</th>
                  <th>Description</th>
                  <th>Attachments</th>
                  <th>Assigned Experts</th>
                  <th class="text-nowrap">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let q of aiQueries">
                  <td class="text-nowrap">
                    <a [routerLink]="['/users/update', q.userId]" class="text-decoration-none">
                      {{ q.userName || '—' }}
                    </a>
                  </td>
                  <td class="text-nowrap">
                    {{ q.userEmail || '—' }}
                  </td>
                  <td class="text-nowrap">
                    {{ q.createdAt | date:'short' }}
                  </td>
                  <td>
                    <button cButton size="sm" color="info" (click)="openDescriptionModal(q)">
                      View
                    </button>
                  </td>
                  <td>
                    <ng-container *ngIf="getAttachmentDisplay(q.aiAttachmentIds)?.length; else noAttach">
                      <a *ngFor="let a of getAttachmentDisplay(q.aiAttachmentIds)" [href]="a.fileUrl" target="_blank" class="d-block text-truncate" style="max-width: 180px;">
                        {{ a.name }}
                      </a>
                    </ng-container>
                    <ng-template #noAttach>
                      <span class="text-muted">—</span>
                    </ng-template>
                  </td>
                  <td style="max-width: 220px;">
                    <span *ngFor="let t of q.assignedTutors; let last = last">
                      {{ t.name }}
                      <small class="text-muted">({{ t.userId }})</small>
                      <span *ngIf="!last">, </span>
                    </span>
                    <span *ngIf="!q.assignedTutors?.length" class="text-muted">
                      Not assigned
                    </span>
                  </td>
                  <td class="text-nowrap">
                    <button cButton size="sm" color="primary" (click)="openAssignTutorModal(q)">
                      Assign
                    </button>
                    <button cButton size="sm" color="warning" class="ms-2 text-white" (click)="notifyUser(q)"
                      [disabled]="!q.assignedTutors?.length"
                      [title]="!q.assignedTutors?.length ? 'Assign an expert first' : 'Notify user'">
                      Notify
                    </button>
                    <button cButton size="sm" color="danger" class="ms-2" (click)="deleteAiQuery(q)">
                      Delete
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-container>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<!-- Description modal -->
<c-modal [(visible)]="showDescriptionModal">
  <c-modal-header>
    <h5>Query Description</h5>
  </c-modal-header>
  <c-modal-body>
    <p class="mb-0" style="white-space: pre-wrap">{{ activeDescription }}</p>
  </c-modal-body>
  <div class="modal-footer">
    <button cButton color="secondary" (click)="showDescriptionModal=false">
      Close
    </button>
  </div>
</c-modal>

<!-- Assign Expert modal -->
<c-modal [(visible)]="showAssignModal">
  <c-modal-header>
    <h5>Assign Expert</h5>
  </c-modal-header>
  <c-modal-body>
    <ng-select [items]="categories" bindLabel="name" bindValue="_id" placeholder="Category"
      [(ngModel)]="assign.categoryId" (change)="loadSubjects()">
    </ng-select>
    <ng-select class="mt-2" [items]="assign.subjects" bindLabel="name" bindValue="_id" placeholder="Subject"
      [(ngModel)]="assign.subjectId" (change)="loadTutors()">
    </ng-select>
    <ng-select class="mt-2" [items]="assign.tutors" bindLabel="name" bindValue="_id" [multiple]="true"
      [closeOnSelect]="false" [clearable]="true" placeholder="Select Experts" [(ngModel)]="assign.tutorIds">
      <ng-template ng-label-tmp let-item="item" let-clear="clear">
        <span>
          {{ item.name }}
          <small class="text-muted">({{ item.userId }})</small>
        </span>
        <span class="ng-value-icon right" (click)="clear(item)" aria-hidden="true">×</span>
      </ng-template>
      <ng-template ng-option-tmp let-item="item">
        <div class="d-flex justify-content-between">
          <span>
            {{ item.name }}
            <small class="text-muted">({{ item.userId }})</small>
          </span>
        </div>
      </ng-template>
    </ng-select>
  </c-modal-body>
  <div class="modal-footer">
    <button cButton color="secondary" (click)="showAssignModal=false">Cancel</button>
    <button cButton color="success" (click)="saveTutorAssignment()">Save</button>
  </div>
</c-modal>
