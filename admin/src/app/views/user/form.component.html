<c-row gutter="3">

  <!-- LEFT PROFILE CARD -->
  <c-col md="3" *ngIf="!loading">
    <app-profile-card
      [user]="info"
      (afterUpload)="afterUpload($event)">
    </app-profile-card>
  </c-col>

  <!-- RIGHT FORM -->
  <c-col md="9">
    <c-card>

      <!-- HEADER -->
      <c-card-header *ngIf="info?._id; else createHeader">
        <h4>Update User</h4>
      </c-card-header>

      <ng-template #createHeader>
        <c-card-header>
          <h4>Create User</h4>
        </c-card-header>
      </ng-template>

      <c-card-body>

        <!-- LOADING -->
        <div *ngIf="loading; else formTemplate" class="d-flex justify-content-center p-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- FORM -->
        <ng-template #formTemplate>
          <form
            cForm
            #frm="ngForm"
            (ngSubmit)="submit(frm)"
            novalidate
            class="needs-validation"
            [validated]="customStylesValidated">

            <c-row>

              <!-- FULL NAME -->
              <c-col md="6">
                <div class="mb-3">
                  <label cLabel>Full Name</label>
                  <input
                    cFormControl
                    [(ngModel)]="info.name"
                    name="name"
                    required
                    placeholder="Enter name"
                    #name="ngModel" />
                  <c-form-feedback *ngIf="name.invalid && (name.touched || isSubmitted)" invalid>
                    Name is required
                  </c-form-feedback>
                </div>
              </c-col>

              <!-- EMAIL -->
              <c-col md="6">
                <div class="mb-3">
                  <label cLabel>Email</label>
                  <input
                    cFormControl
                    type="email"
                    [(ngModel)]="info.email"
                    name="email"
                    required
                    placeholder="user@example.com"
                    #email="ngModel" />
                  <c-form-feedback *ngIf="email.invalid && (email.touched || isSubmitted)" invalid>
                    Valid email required
                  </c-form-feedback>
                </div>
              </c-col>

              <!-- PHONE -->
              <c-col md="6">
                <div class="mb-3">
                  <label cLabel>Phone Number</label>
                  <input
                    cFormControl
                    [(ngModel)]="info.phoneNumber"
                    name="phone"
                    required
                    minlength="9"
                    maxlength="15"
                    placeholder="Enter phone"
                    #phone="ngModel" />
                  <c-form-feedback *ngIf="phone.invalid && (phone.touched || isSubmitted)" invalid>
                    Phone number is invalid
                  </c-form-feedback>
                </div>
              </c-col>

              <!-- ADDRESS -->
              <c-col md="6">
                <div class="mb-3">
                  <label cLabel>Address</label>
                  <input
                    cFormControl
                    [(ngModel)]="info.address"
                    name="address"
                    required
                    placeholder="Enter address"
                    #address="ngModel" />
                  <c-form-feedback *ngIf="address.invalid && (address.touched || isSubmitted)" invalid>
                    Address is required
                  </c-form-feedback>
                </div>
              </c-col>
              <!-- BIO -->
              <c-col md="6">
                <div class="mb-3">
                  <label cLabel>Description</label>
                  <textarea
                    cFormControl
                    rows="5"
                    [(ngModel)]="info.bio"
                    name="bio"
                    placeholder="Enter description">
                  </textarea>
                </div>
              </c-col>

              <!-- PASSWORD -->
              <c-col md="6">
                <div class="mb-3">
                  <label cLabel>Password</label>
                  <input
                    cFormControl
                    type="password"
                    [(ngModel)]="info.password"
                    name="password"
                    [required]="!userId"
                    minlength="6"
                    #password="ngModel" />
                  <c-form-feedback *ngIf="password.invalid && (password.touched || isSubmitted)" invalid>
                    Password must be at least 6 characters
                  </c-form-feedback>
                  <small *ngIf="userId" class="text-muted">
                    Leave blank to keep current password
                  </small>
                </div>
              </c-col>

              <!-- STATUS -->
              <c-col md="6">
                <div class="mb-3">
                  <label>Status</label>
                  <div>
                    <input type="checkbox" [(ngModel)]="info.isActive" name="isActive" /> Active
                  </div>
                  <div class="mt-2">
                    <input type="checkbox" [(ngModel)]="info.emailVerified" name="emailVerified" /> Email Verified
                  </div>
                </div>
              </c-col>

              <!-- SAVE -->
              <c-col md="12">
                <button cButton color="primary" type="submit">
                  Save
                </button>
              </c-col>

            </c-row>
          </form>
        </ng-template>

      </c-card-body>
    </c-card>
  </c-col>

</c-row>
<!-- ================= AI QUERIES SECTION ================= -->
<c-card class="mt-4" *ngIf="aiQueries.length">

  <c-card-header>
    <h5>AI Queries</h5>
  </c-card-header>

  <c-card-body>

    <!-- ✅ RESPONSIVE WRAPPER -->
    <div class="table-responsive">
      <table class="table table-bordered align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Time</th>
            <th>Description</th>
            <th>Attachments</th>
            <th>Assigned Tutors</th>
            <th class="text-nowrap">Actions</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let q of aiQueries">

            <!-- TIME -->
            <td class="text-nowrap">
              {{ q.createdAt | date:'short' }}
            </td>

            <!-- DESCRIPTION (BUTTON) -->
            <td>
              <button
                cButton
                size="sm"
                color="info"
                (click)="openDescriptionModal(q)">
                View
              </button>
            </td>

            <!-- ATTACHMENTS -->
            <td>
              <ng-container *ngIf="q.aiAttachmentIds?.length; else noAttach">
                <a
                  *ngFor="let a of q.aiAttachmentIds"
                  [href]="a.url"
                  target="_blank"
                  class="d-block text-truncate"
                  style="max-width: 180px;">
                  {{ a.name }}
                </a>
              </ng-container>

              <ng-template #noAttach>
                <span class="text-muted">—</span>
              </ng-template>
            </td>

            <!-- ASSIGNED TUTORS -->
            <td style="max-width: 220px;">
              <span *ngFor="let t of q.assignedTutors; let last = last">
                {{ t.name }}<span *ngIf="!last">, </span>
              </span>
              <span *ngIf="!q.assignedTutors?.length" class="text-muted">
                Not assigned
              </span>
            </td>

            <!-- ACTIONS -->
            <td class="text-nowrap">
              <button
                cButton
                size="sm"
                color="primary"
                (click)="openAssignTutorModal(q)">
                Assign
              </button>

              <button
                cButton
                size="sm"
                color="danger"
                class="ms-2"
                (click)="deleteAiQuery(q)">
                Delete
              </button>
            </td>

          </tr>
        </tbody>
      </table>
    </div>

  </c-card-body>
</c-card>

<c-modal [(visible)]="showAssignModal">
  <c-modal-header>
    <h5>Assign Tutor</h5>
  </c-modal-header>

  <c-modal-body>

    <ng-select
      [items]="categories"
      bindLabel="name"
      bindValue="_id"
      placeholder="Category"
      [(ngModel)]="assign.categoryId"
      (change)="loadSubjects()">
    </ng-select>

    <ng-select
      class="mt-2"
      [items]="assign.subjects"
      bindLabel="name"
      bindValue="_id"
      placeholder="Subject"
      [(ngModel)]="assign.subjectId"
      (change)="loadTutors()">
    </ng-select>

    <ng-select
      class="mt-2"
      [items]="assign.tutors"
      bindLabel="name"
      bindValue="_id"
      [multiple]="true"
      placeholder="Tutors"
      [(ngModel)]="assign.tutorIds">
    </ng-select>

  </c-modal-body>

 <div class="modal-footer">

    <button cButton color="secondary" (click)="showAssignModal=false">
      Cancel
    </button>

    <button cButton color="success" (click)="saveTutorAssignment()">
      Save
    </button>
  </div>
</c-modal>


<c-modal [(visible)]="showDescriptionModal" size="lg">
  <c-modal-header>
    <h5>Description</h5>
  </c-modal-header>

  <c-modal-body>
    <p class="mb-0 white-space-pre-line">
      {{ activeDescription }}
    </p>
  </c-modal-body>

  <div class="modal-footer">
    <button cButton color="secondary" (click)="showDescriptionModal=false">
      Close
    </button>
  </div>
</c-modal>

