<div class="ai-result-wrapper">

  <!-- ================= FORM STEP ================= -->
  <div *ngIf="aiStep === 'form'" class="result-container">

    <h1 class="heading">
      Your search query is shared below
    </h1>

    <div class="content-container">
      <p class="subtitle-left">
        Review the query below before submitting your request
      </p>
    </div>

    <!-- Search bar only â€“ same border as other blocks, no outer card -->
    <div class="ai-search-bar-block">
      <div class="ai-search-bar-inner">
        <textarea
          #queryTextarea
          [(ngModel)]="query"
          class="ai-search-bar-input"
          placeholder="Enter or change your search..."
          rows="1"
          (input)="resizeSearchBar()"
          (keydown.enter)="onSearchBarKeydown($event)"
        ></textarea>
        <div class="ai-search-bar-actions">
          <button
            type="button"
            class="ai-search-bar-icon ai-search-bar-send"
            aria-label="Search"
            (click)="searchAgain()"
            [disabled]="loading || !query.trim()"
            title="Search">
            <span aria-hidden="true">â†‘</span>
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="error" class="error-msg content-container">
      {{ error }}
    </div>

    <!-- EDITOR -->
    <div class="editor-card">
      <!-- Loader when fetching AI result -->
      <div *ngIf="loading" class="editor-loader">
        <div class="editor-loader-spinner" aria-hidden="true"></div>
        <p class="editor-loader-text">Generating your result...</p>
        <p class="editor-loader-subtext">Analyzing your search and preparing recommendations</p>
      </div>
      <!-- Content when loaded -->
      <ng-container *ngIf="!loading">
        <textarea
          [(ngModel)]="editableText"
          class="editor-box"
          placeholder="Your AI-generated result will appear here..."
        ></textarea>
        <p class="brand-line">Engage Brilliance, Get it Done!</p>
      </ng-container>
    </div>

    <!-- ATTACHMENTS -->
    <div class="editor-card attachment-card">
      <label class="card-label">Attach File (pdf, docx, jpg, png)</label>

      <app-file-upload
        *ngIf="!auth.isLoggedin() || isClientUser"
        [options]="aiFileUploadOptions">
      </app-file-upload>

      <div *ngIf="uploadedAttachments.length > 0" class="attached-files-container">
        <p class="attached-title">Attached Files:</p>

        <div
          *ngFor="let file of uploadedAttachments; let i = index"
          class="file-badge">
          <span class="file-icon">ðŸ“„</span>
          <span class="file-name">{{ file.name }}</span>
          <button class="remove-btn" (click)="removeAttachment(i)">Ã—</button>
        </div>
      </div>
    </div>

    <!-- GUEST DETAILS -->
    <div class="editor-card signup-card" *ngIf="!auth.isLoggedin()">

      <div class="form-row">
         <div class="form-group">
          <label for="emailAddr">Work Email</label>
          <input
            type="email"
            id="emailAddr"
            [(ngModel)]="lead.email"
            placeholder="Work Email"
            class="form-control"
          />

          <!-- DOMAIN CHECK -->
          <div *ngIf="lead.email">
            <div class="domain-check" *ngIf="isCompanyEmail(lead.email)">
              <span class="dot"></span> valid domain
            </div>

            <div class="error" *ngIf="!isCompanyEmail(lead.email)">
              Please use your company email address
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="fullName">Name</label>
          <input
            type="text"
            id="fullName"
            [(ngModel)]="lead.name"
            placeholder="Full Name (optional)"
            class="form-control"
          />
        </div>

        <div class="form-group full-width">
          <label for="phoneNo">Phone No.</label>
          <input
            type="tel"
            id="phoneNo"
            [(ngModel)]="lead.phone"
            placeholder="phone no (optional)"
            class="form-control"
          />
        </div>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="actions-left content-container">
      <button
        type="button"
        class="btn reset-btn"
        (click)="clear()"
        [disabled]="loading || submitting">
        Clear
      </button>
      <button
        type="button"
        class="btn submit-btn"
        (click)="submit()"
        [disabled]="
          submitting ||
          (!auth.isLoggedin() && !isCompanyEmail(lead.email))
        ">
        Submit
      </button>
    </div>
  </div>

  <!-- ================= OTP STEP ================= -->
  <div *ngIf="aiStep === 'otp'" class="result-container otp-container">

    <h2 class="heading">Verify Your Email</h2>

    <p class="subtitle-left">
      Weâ€™ve sent a 6-digit verification code to
      <strong>{{ lead.email }}</strong>
    </p>

    <div class="editor-card">
      <input
        type="text"
        class="form-control otp-input"
        maxlength="6"
        placeholder="Enter OTP"
        [(ngModel)]="otpCode"
      />
    </div>

    <div class="actions-right content-container">
  <button
    type="button"
    class="btn submit-btn"
    (click)="verifyOtp()"
    [disabled]="submitting">
    Verify & Submit
  </button>

  <button
    type="button"
    class="btn link-btn"
    (click)="resendOtp()"
    [disabled]="otpTimer > 0">
    Resend OTP {{ otpTimer > 0 ? '(' + otpTimer + 's)' : '' }}
  </button>
</div>

  </div>

  <!-- ================= SUCCESS STEP ================= -->
  <div *ngIf="aiStep === 'success'" class="confirmation">
    {{ confirmationText }}

    <div class="redirect-note">
      Redirecting to
      {{ auth.isLoggedin() ? 'dashboard' : 'homepage' }}
      in {{ countdown }} seconds...
    </div>
  </div>

</div>

<app-blog-section></app-blog-section>
<app-make-it-happen></app-make-it-happen>
<app-policies-section></app-policies-section>